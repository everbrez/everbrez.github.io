---
layout: post
title: Nodejs
date:   2019-02-20
categories: javascript
---
严格来说，一切动作都是事件，这就是事件驱动的思想

# 事件驱动
就是把网络请求、I/O操作看作是事件，在程序启动的时候，便进入事件循环，不断遍历执行事件队列中产生的事件。而在执行的过程中又产生新的事件，这就是事件循环。

事件驱动原理：观察者模式（事件发布/订阅模式）

# 特点

- 事件驱动
- 非阻塞式IO
- 单线程
  - 无法利用多核CPU
  - 错误会引起整个应用退出
  - 大量计算占用CPU会导致无法继续调用异步IO
  - 同前端WebWorker，node通过child_process来将计算分发给子进程

# 多进程架构
创建子进程：
1. spawn：启动一个子进程来执行命令
2. exec：启动要给子进程来执行命令，与spawn不同的是，它有一个回调函数获知子进程的状况
3. execFile：启动一个子进程来执行可执行文件
4. fork：与spawn类似，不同点在于它创建时只需要指定要执行的JavaScript文件模块即可

```js
const cp = require('child_process')

cp.spawn('node', ['worker.js'])
cp.exec('node worker.js', function(err, stdout, stderr) {
  //...
})

cp.execFile('worker.js', function(err, stdout, stderr) {
  //...
})

cp.fork('./worker.js')
```

## 进程之间的通信

```js
// main.js
const cp = require('child_process')
const n = cp.fork('./worker')

n.on('message', function(data) {
  console.log('n:', data)
})

n.send('n->data')

// worker.js
process.on('message', function(data) {
  console.log('process:', data)
})

process.send({data: 23})
```


### 通信原理

IPC Inter-Process Communication，进程间通信。
Node中实现IPC通道的是管道（pipe）技术。具体细节由libux提供